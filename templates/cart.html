<!-- Extends the main layout so this page uses the shared navbar and styling -->
{% extends 'base.html' %}

<!-- Sets the page title shown in the browser tab -->
{% block title %}Cart - Online Bookstore{% endblock %}

<!-- Main content area for the cart page -->
{% block content %}

<!-- Page heading -->
<h2 style="margin: 3.5rem 0 1rem 0; font-size: 1.8rem; color: #000;">My Cart</h2>

<!-- Check if the cart has items -->
{% if cart_items %}

<!-- Container for the shopping cart table -->
<div class="cart-table">
    
    <!-- Start of the HTML table -->
    <table>
        
        <!-- Table header: defines column titles -->
        <thead>
            <tr>
                <!-- Column for the book title and author -->
                <th>Book</th>
                <!-- Column for the price of a single book -->
                <th>Unit Price</th>
                <!-- Column for the quantity of the book in the cart -->
                <th>Quantity</th>
                <!-- Column for the subtotal (price × quantity) -->
                <th>Subtotal</th>
            </tr>
        </thead>

        <!-- Table body: will display each item in the cart -->
        <tbody>
            <!-- Django template loop: repeat the following <tr> for every item in cart_items -->
            {% for item in cart_items %}
            <tr>
                <!-- Book title and author column -->
                <td>
                    <!-- Display the book title in bold -->
                    <strong>{{ item.book.title }}</strong><br>
                    <!-- Display the author in smaller, grey text -->
                    <span style="color: #666;">{{ item.book.author }}</span>
                </td>

                <!-- Price per single book -->
                <td>
                    ${{ item.book.price }} <!-- Access the price of this book -->
                </td>

                <!-- Quantity of this book in the cart -->
                <td>
                    {{ item.quantity }} <!-- Access the quantity property of the item -->
                </td>

                <!-- Subtotal for this specific book (price × quantity) -->
                <td style="color: #e53e3e; font-weight: bold;">
                    ${{ item.subtotal }} <!-- Display the subtotal in bold red -->
                </td>
            </tr>
            {% endfor %} 
        </tbody>
    </table> 
</div> 

<!-- Total price and order button -->
<div class="cart-total">
    <h3>Total: ${{ total }}</h3>

    <!-- Button triggers order creation -->
    <button onclick="createOrder()" class="btn btn-success" 
            style="margin-top: 1rem; font-size: 1.1rem; padding: 0.5rem 1.3rem;">
        Place Order
    </button>
</div>

{% else %}
<!-- Message shown when the cart is empty -->
<div class="alert alert-success">
    Your cart is empty. <a href="/">Start shopping</a>!
</div>
{% endif %}

<!-- JavaScript: handles order creation -->
<script>
function createOrder() {
    // Confirm before placing the order
    if (!confirm('Are you sure you want to place this order?')) return;

    // Send POST request to create the order
    fetch('/create-order/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'), // CSRF token for security
        }
    })
    .then(response => response.json())  // Convert the server's JSON response into a JavaScript object
    .then(data => {  // Use the parsed data to handle the result of the request
        // If successful, redirect to orders page
        if (data.success) {
            alert('Order created successfully!');
            window.location.href = '/orders/';
        } 
        // If failed, show error message
        else {
            alert('Failed to create order: ' + data.error);
        }
    });
}
</script>

{% endblock %}
